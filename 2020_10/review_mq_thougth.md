---
sort: 1
title: MQ消费优雅重试
tags: RocketMQ 消费者 消息重试
---

# MQ消费失败优雅重试



## 前言

​		公司用的RocketMQ，别问为什么选择它，问就是买的阿里云消息服务RocketMQ版本（免运维）。圆规正转，最近在review同事的业务代码，其中有一块涉及到MQ消费端的业务逻辑处理，发现一些不规范的处理，会导致失败消息堆积，比如本文将聊一聊的[**消息重试**](https://wesleyone.github.io/rocketmqCake/basic/features.html#9-%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95)

```info
“消息重试”：Consumer消费消息失败后，要提供一种重试机制，令消息再消费一次。
```



## 现象及思考

```java
try {
  // 业务处理
  doBusiness(Message);
  // 消费成功
  return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
} catch (Exception e) {
  // 消费失败
  return ConsumeConcurrentlyStatus.RECONSUME_LATER;
}
```

​		如上简化的代码所示，我司对处理MQ消息者做了层封装，业务正常完成则返回`CONSUME_SUCCESS`，凡是封装层捕捉到异常，就会返回`RECONSUME_LATER`，会触发**消息重试** 。最近review同事代码，发现针对这些异常均不作为，没有分析**消息重试**的必要性，所以一旦有任何异常，都会触发消息重试。显然这里面就有值得商榷的地方。下面例举几种情况：

- 消息字段校验失败。接收到消息后，往往第一步就是消息中核心参数校验，防止在后续使用到核心参数产生空指针等异常。那么消息字段校验失败，需要**消息重试**吗？通常是没有**消息重试**的意义的，因为消息的参数是不会改变的，即使**消息重试**，仍然会出同样的错，所以没有必要，业务上记录日志等待排查原因即可。
- 消息幂等校验失败。RocketMQ集群模式下，一条消息只会由一个消费者消费，另外业务层面为了减少重复消费，会加幂等校验逻辑。消息幂等校验失败，需要**消息重试**吗？通常也是没有**消息重试**的意义的，理由同上。
- RPC请求异常/业务返回失败。RPC请求异常中，较常见的有超时、服务找不到等，RPC业务返回失败的原因就更加千姿百态了。需要**消息重试**吗？这个真的要“见人说人话，见鬼说鬼话”了，像超时、服务找不到等请求异常，修复后是有可能消费成功的，那么允许**消息重试**，RPC业务返回错误码情形下，就要判断该RPC业务接口在**消息重试**时重新调用会不会成功，所以要_特案特例_。
- 持久化异常。数据库操作异常，可能是会话连接异常，也有可能是SQL有问题，也有可能是乐观锁更新失败，也有可能是新增数据唯一键冲突。这里讲下唯一键冲突，如果唯一键数据是来源于消息字段，那么情况同_消息幂等校验_，即使**消息重试**，仍然会报同样的错，实质上唯一键常用来做幂等操作，可以酌情放弃**消息重试**。
- 代码BUG异常。通过修复BUG后，可以通过**消息重试**完成正常消费。

​		**消息重试**是有上限的，如果一直重试消费失败，则会被扔进**死信队列**，需要在控制台手动触发重试。

```info
死信队列用于处理无法被正常消费的消息。当一条消息初次消费失败，消息队列会自动进行消息重试；达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息，此时，消息队列 不会立刻将消息丢弃，而是将其发送到该消费者对应的特殊队列中。
```



## 改进建议

1. 业务逻辑层面评估下**消息重试**必要性

2. 封装层面优化，新增不需要重试的异常，如下所示

   ```java
   try {
     // 业务处理
     doBusiness(Message);
     // 消费成功
     return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
   } catch (UnResumeException e1) {
     // 不需要消息重试的异常，消费成功
     return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
   } catch (Exception e) {
     // 消费失败
     return ConsumeConcurrentlyStatus.RECONSUME_LATER;
   }
   ```



## 参考

[RocketMQ文档整理](https://wesleyone.github.io/rocketmqCake/)

